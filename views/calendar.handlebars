<main>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"> <!-- Bootstrap link -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet"> <!-- FullCalendar link -->
    <link href="/public/css/style.css" rel="stylesheet">

    <div class="container mt-4">
        <div class="calendar-container">
            <div id="notification" class="alert alert-success"></div>
            <div id="calendar"></div>
        </div>
    </div>

    <!-- Bootstrap Modal for event creation, deletion and for the update -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">Event Title</label>
                            <input type="text" class="form-control" id="eventTitle" placeholder="Enter event title" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventDate" class="form-label">Event Date</label>
                            <input type="date" class="form-control" id="eventDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventTime" class="form-label">Event Time</label>
                            <input type="time" class="form-control" id="eventTime">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteEventButton">Delete Event</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveEventButton">Save Event</button>
                </div>
            </div>
        </div>
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script> <!-- Bootstrap script link -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>     <!-- FullCalendar script link -->

    <script>
        document.addEventListener('DOMContentLoaded', function (){
            const calendarElement = document.getElementById('calendar');
            const eventModalElement = document.getElementById('eventModal');
            const modalInstance = new bootstrap.Modal(eventModalElement);
            const notificationElement = document.getElementById('notification');

            const calendar = new FullCalendar.Calendar(calendarElement,{
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: '',
                },
                events: '/calendar/getEvents',
                dateClick: function (info) {
                    resetModal();
                    document.getElementById('modalTitle').innerText = 'Add Event';
                    document.getElementById('eventDate').value = info.dateStr;
                    document.getElementById('saveEventButton').dataset.mode = 'add';
                    modalInstance.show();
                },
                eventClick: function (info){
                resetModal();
                document.getElementById('modalTitle').innerText = 'Update or Delete Event';
                document.getElementById('eventTitle').value = info.event.title;

                document.getElementById('eventDate').value = info.event.startStr.split('T')[0];

                const time = info.event.startStr.split('T')[1]; // Get the time portion
                document.getElementById('eventTime').value = time ? time.slice(0, 5) : ''; // Format as HH:mm

                document.getElementById('saveEventButton').dataset.mode = 'edit';
                document.getElementById('saveEventButton').dataset.eventId = info.event.id;
                document.getElementById('deleteEventButton').dataset.eventId = info.event.id;
                document.getElementById('deleteEventButton').style.display = 'inline-block';

                modalInstance.show();
                }
            });

            calendar.render();

            // Save Event
            document.getElementById('saveEventButton').addEventListener('click', async function (){
                const mode = this.dataset.mode;
                const eventId = this.dataset.eventId;
                const title = document.getElementById('eventTitle').value.trim();
                const date = document.getElementById('eventDate').value;
                const time = document.getElementById('eventTime').value;

                if(!title || !date){
                    alert('Title and Date are required.');
                    return;
                }

                if(mode === 'add'){
                    const response = await fetch('/calendar/addEvent',{
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, date, time }),
                    });
                    if(response.ok){
                        showNotification('Event added successfully!');
                        calendar.refetchEvents();
                        modalInstance.hide();
                    } 
                    else{
                        alert('Error adding event.');
                    }
                } 
            // Update event
                else if(mode === 'edit'){
                    if(!eventId){
                        alert("Event ID not found.");
                        return;
                    }

                    const response = await fetch(`/calendar/updateEvent/${eventId}`,{
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, date, time }),
                    });
                    if(response.ok){
                        showNotification('Event updated successfully!');
                        calendar.refetchEvents(); // Refresh the calendar
                        modalInstance.hide();
                    } 
                    else{
                        alert('Error updating event.');
                    }
                }
                resetModal();
            });

            // Delete Event
            document.getElementById('deleteEventButton').addEventListener('click', async function (){
                const eventId = this.dataset.eventId;

                if(!eventId){
                    alert("Event ID not found.");
                    return;
                }

                const response = await fetch(`/calendar/deleteEvent/${eventId}`,{
                    method: 'DELETE',
                });

                if(response.ok){
                    showNotification('Event deleted successfully!');
                    calendar.refetchEvents();
                    modalInstance.hide();
                } 
                else{
                    alert('Error deleting event.');
                }
                resetModal();
            });

            function showNotification(message) {
                notificationElement.innerText = message;
                notificationElement.style.display = 'block';
                setTimeout(() => {
                    notificationElement.style.display = 'none';
                }, 3000); // showing event creation/deletion/updated notification for 3 seconds
            }

            function resetModal() { // reset modal will reset the value of input box after event details are submitted
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventDate').value = '';
                document.getElementById('eventTime').value = '';
                document.getElementById('saveEventButton').dataset.mode = '';
                document.getElementById('saveEventButton').dataset.eventId = '';
                document.getElementById('deleteEventButton').dataset.eventId = '';
                document.getElementById('deleteEventButton').style.display = 'none';
            }
        });
    </script>
</main>

